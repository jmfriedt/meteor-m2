% 12h to decode the whole extrait.s file (11170164 bytes)

% cf medet :
% check rotate_iq in correlator.pas
pkg load communications
pkg load signal

close all
clear all
f=fopen("extrait.s");
% d=fread(f,inf,'int8'); % 4e5
d=fread(f,5e5,'int8'); % <- to illustrate QPSK
fclose(f);
%d=d-mean(d);

%if (1==0)
  mot=0x1ACFFC1D;          % before Viterbi ...
  mot=[0xfc 0xa2 0xb6 0x3d 0xb0 0x0d 0x97 0x94]
  mot=[1 1 1 1 1 1 0 0 ... %  fc
       1 0 1 0 0 0 1 0 ... %  a2
       1 0 1 1 0 1 1 0 ... %  b6
       0 0 1 1 1 1 0 1 ... %  3d
       1 0 1 1 0 0 0 0 ... %  b0
       0 0 0 0 1 1 0 1 ... %  0d
       1 0 0 1 0 1 1 1 ... %  97
       1 0 0 1 0 1 0 0 ... %  94
  ];
  mot=mot-mean(mot); x=xcorr(mot,d); %xx=reshape(x(1:1024*1024),1024,1024);
  subplot(411);plot(abs(x(1:end/2)));ylim([-1 2000]);
  % 11 -> 01 ; 10 -> 11 ; 00 -> 10 ; 01 -> 00
  mot=[0 1 0 1 0 1 1 0 1 1 1 1 1 0 1 1 1 1 0 1 0 0 1 1 1 0 0 1 0 1 0 0 1 1 0 1 1 0 1 0 1 0 1 0 0 1 0 0 1 1 0 0 0 0 0 1 1 1 0 0 0 0 1 0 ];
  mot=mot-mean(mot); x=xcorr(mot,d); %xx=reshape(x(1:1024*1024),1024,1024);
  subplot(412);plot(abs(x(1:end/2)));ylim([-1 2000]);
  % 11 -> 11 ; 00 -> 00 ; 10 -> 01 ; 01 -> 10
  mot=[1 1 1 1 1 1 0 0 0 1 0 1 0 0 0 1 0 1 1 1 1 0 0 1 0 0 1 1 1 1 1 0 0 1 1 1 0 0 0 0 0 0 0 0 1 1 1 0 0 1 1 0 1 0 1 1 0 1 1 0 1 0 0 0 ];
  mot=mot-mean(mot); x=xcorr(mot,d); %xx=reshape(x(1:1024*1024),1024,1024);
  subplot(413);plot(abs(x(1:end/2)));ylim([-1 2000]);
  % 11 -> 01 ; 01 -> 11 ; 00 -> 10 ; 10 -> 00
  mot=[0 1 0 1 0 1 1 0 0 0 0 0 1 0 0 0 0 0 0 1 1 1 0 0 1 0 0 1 0 1 1 1 0 0 0 1 1 0 1 0 1 0 1 0 0 1 1 1 0 0 1 1 1 1 0 1 0 0 1 1 1 1 1 0 ];
  mot=mot-mean(mot); x=xcorr(mot,d); %xx=reshape(x(1:1024*1024),1024,1024);
  subplot(414);plot(abs(x(1:end/2)));ylim([-1 2000]);  % this word yields the right correlation
%end

% corrects the error in the constellation to find the right synchronization word
d(2:2:end)=-d(2:2:end);
mot=[1 1 1 1 1 1 0 0 ... %  fc
     1 0 1 0 0 0 1 0 ... %  a2
     1 0 1 1 0 1 1 0 ... %  b6
     0 0 1 1 1 1 0 1 ... %  3d
     1 0 1 1 0 0 0 0 ... %  b0
     0 0 0 0 1 1 0 1 ... %  0d
     1 0 0 1 0 1 1 1 ... %  97
     1 0 0 1 0 1 0 0 ... %  94
];
mot=mot-mean(mot); x=xcorr(mot,d); x=x(1:length(mot)+length(d));
% figure;plot(x); % ... we check that we correlate with the right sentence

if (1==1)  % might want to skip the demonstration to decode the whole d dataset
  k=find(abs(x)>1500);k=k(1)
  for m=1:18000
    dd=d(m:m+128-1); % 8 bytes = 64 bits = 128 bits after viterbi
    x=xcorr(mot,dd); x=x(1:length(mot)+length(dd));
    if (max(abs(x))>1400) 
       printf("%d\n",m);
       phrase=(dd<0); % 1 if dd>0, 0 otherwise SWAP BITS (again ?!)
       phrase=phrase';
  %%%%%%%%%%%%%%%%%%%%%
  % https://github.com/Filios92/Viterbi-Decoder/blob/master/viterbi.m
  [decoded,e]=viterbi([1 1 1 1 0 0 1 ; 1 0 1 1 0 1 1 ],phrase,0);
  ddd=(decoded(1:4:end)*8+decoded(2:4:end)*4+decoded(3:4:end)*2+decoded(4:4:end));
  dec2hex(ddd)'
  
  %%%%%%%%%%%%%%%%%%%%%
  
       u=find(ddd==(0x1a));
       if ((!isempty(u))&&(u<length(ddd)) )
          if (ddd(u+1)==(0xcf))
             dec2hex(ddd)'
             dddd=ddd;
          end
       end
       plot(abs(x))
    end 
  end
end
 
return
 
m=4757
dd=d(m:m+24*16384);   % 8 bytes = 64 bits = 128 bits after viterbi  -> HERE select the size of decoded !
% dd=d(m:end);        % 8 bytes = 64 bits = 128 bits after viterbi  -> HERE select the size of decoded !
phrase=(dd<0); % 1 if dd>0, 0 otherwise SWAP BITS (again ?!)
phrase=phrase';
% https://github.com/Filios92/Viterbi-Decoder/blob/master/viterbi.m
[decoded,e]=viterbi([1 1 1 1 0 0 1 ; 1 0 1 1 0 1 1 ],phrase,0);
ddd=(decoded(1:4:end)*8+decoded(2:4:end)*4+decoded(3:4:end)*2+decoded(4:4:end));
dec2hex(ddd)'
  
  % A1ACFFC1DBF4D8263B10D70BC8E3EDE28EC9DD47D374BCC5C7BA5CE060DF6E4779C8DE7B6FF2F1D81369254051C59575B4F917DF8496786489BAC90A652B47BD32DFAAADCDB37F09AF6BF1DC15BDC4C382BD4AB42F29F3A417930DEC8248420F84B4E49C07677574533C2835EF8491E2BBB9D0826E25AA5F19B0030821A1E177C5537C93ED71E9D8365026E9D504FE6FC9DE59DC63EADD6D30E478D1021F3EEE8C0406174719F187FC253385D732866106770134FC3F589863B6B74781A8E70416B0C907E7C66519E33E4D432B0F14CE49147DE1C65C2A2ED656E13DF990AD0C55E595435705D8CA161E0156DD0ED9E845881E1E5B9EB22B8D3DF7B70CE06AA2E9F5F75EC27F8449ECBA2FB873B9F07D573014E85658C5FC02E5F4E3B8EF4F5996E81F700AB54D93DF78C6B7F3833CAC7D21B037E47719B452C7D35793A579C902B7425CAB597898577A767DA2803406E6D1056D32DB81EA979EA95E35BCADC0D7E6A87EEEA85558CAA9C53C1B0318910910D5645BDBA71C8547FADF16968262A651F9276260CE108E16D625468061C1251FD1B7BE595E8E68CC08F8455053B3534EB353B06DBBA1216919D10D115DC507E8E0A7820AF5AEA8A7FA38C1AD6B382CCE366EB1F30E02A87E651A5458DF0A9B9164F72C60712CB85DFE44ED1022413F8759819789F4546B556453749D6D153161B2D4BC0E619AEAFFBF947236D1F25C9F8BC63AA5017ED521EE11554371C018E4FCD7253D584CC977FA11B8DD2BF54F5C666F2550FC3DB399C94CC651548F69988E768CBD03923C7B573BA0EC79B1CB3D473C14DA24B1BDEC3F1941272DED161A72A7D65857C6ECC0BFE3374163F7CD3AADAD0193558B71C9273A08D22F45F8624897B740C28E5E8ADEF694889BAF9B6F4B272C0720D0902C9D0B9F3FE4ADFF9B0C4FC6FE711314A81C87DE20D1F85758A50BA2B4953217089702AFBD627B490F7C527952613D9FC582C7801205F9BC2DA9136E899A27EAC73F66585C7D8CA8E615617D82072D4D2C86E3AD7B2DE6810EC784C075B9BCF438313008D456F9B1C56DAEA9222B92B549E716A95ED2D865D02DCB44867FBABF1C8F9FF343595228B02B4064C1417FE44F473792E128960FB086BFA548165EA11663EDB7FB828637BFCD5C501C31D97AED14E9234FC50BFB3149A95AB45F8646E9715A1072557F53D02D69D4367560C354CF291EFD17E7C2A60165F17713356CEB930146F3123702BA3DB7DB5F109E9B52791F24B19B9A1BEA58ECB2CC8F65F5FA2F27B6F10F7DBBB129D529B4E626559906F52AFE88E29990A1103BFDD04552638E7F1F2D1CAC8D63F878869B7D13F2ABAC6D2D7742CAC1C13208635FA8207BBDC05F341A8F9DD8911072D035DA0AE4490A2B20CA14023D7A19A8AE61A5F7B3D5823246A9796FB43F652231B525D5D245D3E9278D6F1471ACFFC1DBF4D8263B60D70BC8EA23511163DA82D1744906B7538908E4AE6022BD5F16058D83092F7727405F72DA2C5419278CE797905376D5E0CD393C6EFF8D4921DF5C8F0E470260042C79B5BEAA9CE7B8BAC81599ED718F87A6BBA79922C1917F26E28D458C8786783C16C9CDF39B10F70380A15B8F64324A07B028DCEB70A491E7120C149C88B7B021005CC1A12F754ED42A58DD68AE73C4AAC1FA94F15804D21AB1FEB896D6F41AE9B91C56D85D008921F0FD74BB84541962B64C4162E3A547C4F520E3DC3B54CF1444B715B30C6CC9A080917743E603A324A74AD86D5ABD134C2C9328DBC8032C9CFC0621D36616EDE7CDC7C7C9809A1E923DB15A8F15FF1BF05D800D8B41DFE5303D36EDEE76D7B9B319E51B726713D0B83C396EA2035A6A59396B61619D0B5C06F313C15A6ECA30478E5FE5B6121F5335D0FEA9AE8E8FB854D878B2443230785DC76540726BC1BC0890839CF56F12C26A0A7D322BE533F92F36BAF032E38AE1D66BFA80257593C602DEC472F2FDC16DDDFF92AC70DE3EB442326FC46510E30C2C40E317F278808C44FA62BC2F31A18AA02D032DC3AE7A04D2F2C7191D9AFABC88FADB17BC4CED35FB4D6E5502BFAF5C1F38178C42CC78A665215E7959A6F5A058709FC2DB9E0A549EDE2FCB8143D5306A143AACF9E3B5C2FB3E87EAAE30AD8CC1FEACF8680FD9F3153ECD58B70FB8358E03C89F9E680241453EC35043C0FAB92CF7B243D616FD64C2CF809E678779437C887A41C541C0D7ABE4B84D19F1EAC9F63B941DF6E323DB50C579BF38F7A74964E7758F0E8957E0CD8CCB470574AA58740251FDCF6736F720271F2D5772F2E33514C41D6A76F37A977D42135488E0845649310E396DB911B0261F00C349BC6786A1126F26489B1CC91E79BF8A16220587250E53688AE84FBB386C08227E93D6668B3C00C878521E0E141D519435D1791C71AC0C8F6E843CB521049E2A338EA2A84EC4AA92048598CBB99DFAD6DA061D0D0F8AC1B9196D23BCE34D965587506F0C2EF66EC54469C6602BEDA7B87564C5FB9DF9C2A32DF0A80E50D0516410353F3FF8A9C32EDABCDA6E9988875B87B37773A56FB74E7FE87409C46016BC4B232050A4420C3A259E92901417D78CE0F054BF709FA3CDDC72F05B42579456A6CA2497A5DA00C0F8B1A6B735DF5E0C2F4608E54C881128162CB72B01CBA320F0D5B6FD9EB07BFD325962D343DCCFCDD2F5BA94066488802BC2BF3A9C4C5E57FEECAEF16E35B3AD8C3F2E533CB99FF8AE20A0D5F20C7D89F325F1659CA9EEAB9AA73BB93E4CA865C1EEC2A5F1F1084032AA33E277F0453D35C6ABEC0A2D941892D061380CB8CA13598CAC650804674B18BDAC0A74C2DA5D5E72D0EEE8813CA28E30EF43487BD89EF7CC32D83E60322CBF2F27942063B5C082C4F126F50F8DCF30C6F5FEF51E224126
